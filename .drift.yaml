# Drift Configuration for drift project
# This file defines custom rule definitions specific to this project

providers:
  claude-code:
    provider: claude-code
    params: {}

models:
  sonnet:
    provider: claude-code
    model_id: sonnet
    params:
      max_tokens: 4096
      temperature: 0.0
  haiku:
    provider: claude-code
    model_id: haiku
    params:
      max_tokens: 4096
      temperature: 0.0

default_model: sonnet

agent_tools:
  claude-code:
    conversation_path: ~/.claude/projects/
    enabled: true

conversations:
  mode: latest
  days: 7

temp_dir: /tmp/drift

rule_definitions:
  # All rules are project-level focused on documentation quality
  skill_completeness:
    description: "Claude Code skills missing essential components or clarity"
    scope: project_level
    context: "Incomplete skills create confusion and slow development. Skills must be self-contained with clear examples and dependencies."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: skill
      file_patterns:
        - .claude/skills/*/SKILL.md
      bundle_strategy: individual
      resource_patterns:
        - "**/*.py"
        - "**/*.js"
        - "**/*.md"
        - "**/*.ts"
    phases:
      - name: structural_quality
        type: prompt
        prompt: |
          Evaluate the skill's structural quality per Anthropic's Agent Skills best practices.

          CRITICAL ISSUES (report these):
          1. Frontmatter description COMPLETELY MISSING "when to use" or "use when" phrase
          2. Multi-page templates or large reference content dumped inline (>100 lines of template/boilerplate)
          3. Entire skill is just vague responsibilities with NO actionable instructions anywhere

          ACCEPTABLE (do NOT report):
          - Any "Use when..." phrase in frontmatter, even if brief (e.g., "Use when writing tests" is FINE)
          - Skills that start with brief intro then dive into instructions
          - "Core Responsibilities" sections IF followed by actionable content
          - References to project files/scripts (assume they exist)
          - Missing examples IF the skill content is self-explanatory

          EXAMPLES OF WHAT TO IGNORE:
          - "Use when writing or structuring issues" ✓ ACCEPTABLE
          - "Use when fixing linting errors" ✓ ACCEPTABLE
          - "Expert in X" then actionable content ✓ ACCEPTABLE

          ONLY REPORT if there's a REAL structural problem, not style nitpicks.
        available_resources:
          - skill
      - name: verify_dependencies
        type: prompt
        prompt: |
          If the skill references other skills, verify they exist by requesting them.
          Only flag missing references to actual dependency skills.
        available_resources:
          - skill
      - name: final_quality_check
        type: prompt
        prompt: |
          Review all findings from previous phases.

          ONLY report CRITICAL structural problems:
          - Missing "use when" activation criteria entirely
          - Massive content dumps (templates >100 lines inline)
          - No actionable instructions anywhere

          IGNORE minor style issues:
          - Slight wording variations in "use when" phrases
          - Brief introductory sections
          - "Core Responsibilities" if actionable content follows
        available_resources:
          - skill

  agent_completeness:
    description: "Claude Code agents missing essential components or clarity"
    scope: project_level
    context: "Incomplete agents create confusion about delegation and task automation. Agents must clearly define their scope and dependencies."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: agent
      file_patterns:
        - .claude/agents/*.md
      bundle_strategy: individual
      resource_patterns: []
    phases:
      - name: workflow_quality
        type: prompt
        prompt: |
          Evaluate the agent's workflow guidance and task delegation clarity.

          CRITICAL ISSUES (report these):
          - Agent has NO purpose or scope explanation anywhere
          - Agent provides ZERO workflow guidance (doesn't explain how to approach tasks at all)
          - Agent is completely missing examples

          ACCEPTABLE (do NOT report):
          - References to MCP tools without explaining setup
          - Brief or general workflow descriptions (some guidance is better than none)
          - Agent lists responsibilities without exhaustive decision criteria
          - References to standard project scripts/tools

          ONLY REPORT if there's a REAL problem, not style nitpicks.
        available_resources:
          - agent
      - name: verify_references
        type: prompt
        prompt: |
          If the agent references other agents or skills, verify they exist by requesting them.
          Only flag missing references to actual dependency agents or skills.
        available_resources:
          - agent
          - skill
      - name: final_quality_check
        type: prompt
        prompt: |
          Review all findings from previous phases.

          ONLY report CRITICAL problems:
          - Missing workflow guidance entirely
          - No purpose/scope explanation at all
          - Completely missing examples

          IGNORE minor issues and style preferences.
        available_resources:
          - agent
          - skill

  command_completeness:
    description: "Claude Code commands missing essential components or clarity"
    scope: project_level
    context: "Incomplete commands miss validation steps and create workflow inefficiency. Commands must declare dependencies and provide clear execution steps."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: command
      file_patterns:
        - .claude/commands/*.md
      bundle_strategy: individual
      resource_patterns: []
    phases:
      - name: execution_clarity
        type: prompt
        prompt: |
          Evaluate the command's execution clarity and usability.

          CRITICAL ISSUES (report these):
          - Command has NO purpose explanation anywhere
          - Command provides ZERO execution guidance (no steps at all)
          - Invocation syntax completely missing or totally unclear

          ACCEPTABLE (do NOT report):
          - References to project scripts (./test.sh, ./lint.sh)
          - References to MCP tools by name
          - Parameter placeholders like <issue_number>, $ARGUMENTS
          - Brief execution steps (some guidance is better than none)
          - Missing exhaustive success criteria (nice-to-have)

          ONLY REPORT if there's a REAL problem, not style nitpicks.
        available_resources:
          - command
          - skill
          - agent
      - name: verify_dependencies
        type: prompt
        prompt: |
          If the command references other commands, skills, or agents, verify they exist.
          Only flag missing references to actual dependencies.
        available_resources:
          - command
          - skill
          - agent
      - name: final_quality_check
        type: prompt
        prompt: |
          Review all findings from previous phases.

          ONLY report CRITICAL problems:
          - Missing purpose entirely
          - Zero execution guidance
          - Completely unclear invocation

          IGNORE minor issues and style preferences.
        available_resources:
          - command
          - skill
          - agent

  command_consistency:
    description: "Commands contradict project guidelines or each other"
    scope: project_level
    context: "Contradictory commands create confusion and workflow inefficiency. Commands must be consistent with project guidelines and declare their dependencies."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: mixed
      file_patterns:
        - .claude/commands/*.md
        - CLAUDE.md
      bundle_strategy: collection
      resource_patterns: []
    phases:
      - name: consistency_check
        type: prompt
        prompt: |
          Analyze commands for ACTUAL contradictions, not cosmetic differences.

          Project root: {project_root}
          Files: {files_with_paths}

          ONLY report if you find CONTRADICTIONS:
          1. Command A says "do X before Y", Command B says "do Y before X" (for the same task)
          2. Commands require mutually exclusive tools or conflicting workflows
          3. Commands explicitly contradict CLAUDE.md guidelines

          DO NOT REPORT (these are NOT issues):
          - All commands say "activate skills at step 1" - this is PERFECT consistency
          - All commands say "activate before proceeding" + show activation at step 1 - this is CLEAR and CONSISTENT
          - Wording variations like "MUST activate" vs "must activate" vs "Activate" - meaningless difference
          - Commands for different tasks have different workflow steps - this is EXPECTED and CORRECT
          - "before proceeding" appearing in multiple commands - this is CONSISTENCY, not inconsistency

          EXAMPLE OF REAL CONTRADICTION (report this):
          - Command A: "Activate skills before gathering info"
          - Command B: "Gather info before activating skills"

          EXAMPLE OF NON-ISSUE (DO NOT report this):
          - Command A: "MUST activate skills before proceeding. Steps: 1. Activate skills 2. Do work"
          - Command B: "MUST activate skills before proceeding. Steps: 1. Activate skills 2. Do work"
          - These are IDENTICAL behaviors with the same wording - perfectly consistent!

          If all commands follow the same activation pattern (step 1 = activate), do NOT report any issue.
        available_resources: []

  claude_md_missing:
    description: "Project missing CLAUDE.md configuration file"
    scope: project_level
    context: "CLAUDE.md provides essential context for Claude Code about project structure and conventions. Missing this file reduces AI effectiveness."
    requires_project_context: true
    supported_clients:
      - claude-code
    phases:
      - name: check_file
        type: file_exists
        file_path: CLAUDE.md
        failure_message: "CLAUDE.md file is missing from project root"
        expected_behavior: "Project should have CLAUDE.md file documenting structure and conventions"

  command_duplicate_dependencies:
    description: "Commands have redundant transitive skill dependencies"
    scope: project_level
    context: "Commands should only declare direct skill dependencies. Transitive dependencies are automatically included."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: mixed
      file_patterns:
        - .claude/commands/*.md
        - .claude/skills/*/SKILL.md
      bundle_strategy: individual
    phases:
      - name: check_duplicates
        type: dependency_duplicate
        description: "Check for redundant transitive dependencies in commands"
        failure_message: "Found redundant skill dependencies in commands"
        expected_behavior: "Commands should only declare direct dependencies, not transitive ones"
        params:
          resource_dirs:
            - .claude/commands
            - .claude/skills

  skill_duplicate_dependencies:
    description: "Skills have redundant transitive skill dependencies"
    scope: project_level
    context: "Skills should only declare direct dependencies on other skills. Transitive dependencies are automatically included."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: skill
      file_patterns:
        - .claude/skills/*/SKILL.md
      bundle_strategy: individual
    phases:
      - name: check_duplicates
        type: dependency_duplicate
        description: "Check for redundant transitive dependencies in skills"
        failure_message: "Found redundant skill dependencies in skills"
        expected_behavior: "Skills should only declare direct dependencies, not transitive ones"
        params:
          resource_dirs:
            - .claude/skills

  agent_duplicate_dependencies:
    description: "Agents have redundant transitive skill dependencies"
    scope: project_level
    context: "Agents should only declare direct skill dependencies. Transitive dependencies are automatically included."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: agent
      file_patterns:
        - .claude/agents/*.md
        - .claude/skills/*/SKILL.md
      bundle_strategy: individual
    phases:
      - name: check_duplicates
        type: dependency_duplicate
        description: "Check for redundant transitive dependencies in agents"
        failure_message: "Found redundant skill dependencies in agents"
        expected_behavior: "Agents should only declare direct dependencies, not transitive ones"
        params:
          resource_dirs:
            - .claude/agents
            - .claude/skills

  command_broken_links:
    description: "Commands contain broken file references or links"
    scope: project_level
    context: "Commands must reference valid files and resources. Broken links cause confusion and errors."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: command
      file_patterns:
        - .claude/commands/*.md
      bundle_strategy: individual
    phases:
      - name: check_links
        type: markdown_link
        description: "Check for broken links in command documentation"
        failure_message: "Found broken links in commands"
        expected_behavior: "All file references and links should be valid"
        params:
          check_local_files: true
          check_external_urls: false
          # Skip common example/placeholder file patterns in documentation
          custom_skip_patterns:
            - '\.py'               # Python files in examples (test_parser.py, cli.py, etc.)
            - '\.yaml'             # YAML config files (config.yaml, drift.yaml, pre-commit-config.yaml, etc.)
            - '\.yml'              # YAML workflow files (test.yml, release.yml, etc.)
            - '\.cfg'              # Config files (setup.cfg, etc.)
            - 'CHANGELOG\.md'      # Changelog references in examples
            - 'github/workflows/'  # GitHub workflow directory references

  skill_broken_links:
    description: "Skills contain broken file references or links"
    scope: project_level
    context: "Skills must reference valid files and resources. Broken links cause confusion and errors."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: skill
      file_patterns:
        - .claude/skills/*/SKILL.md
      bundle_strategy: individual
    phases:
      - name: check_links
        type: markdown_link
        description: "Check for broken links in skill documentation"
        failure_message: "Found broken links in skills"
        expected_behavior: "All file references and links should be valid"
        params:
          check_local_files: true
          check_external_urls: false
          # Skip common example/placeholder file patterns in documentation
          custom_skip_patterns:
            - '\.py'               # Python files in examples (test_parser.py, cli.py, etc.)
            - '\.yaml'             # YAML config files (config.yaml, drift.yaml, pre-commit-config.yaml, etc.)
            - '\.yml'              # YAML workflow files (test.yml, release.yml, etc.)
            - '\.cfg'              # Config files (setup.cfg, etc.)
            - 'CHANGELOG\.md'      # Changelog references in examples
            - 'github/workflows/'  # GitHub workflow directory references

  agent_broken_links:
    description: "Agents contain broken file references or links"
    scope: project_level
    context: "Agents must reference valid files and resources. Broken links cause confusion and errors."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: agent
      file_patterns:
        - .claude/agents/*.md
      bundle_strategy: individual
    phases:
      - name: check_links
        type: markdown_link
        description: "Check for broken links in agent documentation"
        failure_message: "Found broken links in agents"
        expected_behavior: "All file references and links should be valid"
        params:
          check_local_files: true
          check_external_urls: false
          # Skip common example/placeholder file patterns in documentation
          custom_skip_patterns:
            - '\.py'               # Python files in examples (test_parser.py, cli.py, etc.)
            - '\.yaml'             # YAML config files (config.yaml, drift.yaml, pre-commit-config.yaml, etc.)
            - '\.yml'              # YAML workflow files (test.yml, release.yml, etc.)
            - '\.cfg'              # Config files (setup.cfg, etc.)
            - 'CHANGELOG\.md'      # Changelog references in examples
            - 'github/workflows/'  # GitHub workflow directory references

  claude_skill_permissions:
    description: "Project skills missing from Claude Code settings permissions"
    scope: project_level
    context: "All skills in .claude/skills/ must have corresponding Skill() permission entries in .claude/settings.json. Missing permissions prevent skills from being used."
    requires_project_context: true
    supported_clients:
      - claude-code
    phases:
      - name: check_skill_permissions
        type: claude_skill_settings
        failure_message: "Skills missing from .claude/settings.json permissions.allow array"
        expected_behavior: "Every skill directory in .claude/skills/ should have a corresponding Skill(name) entry in .claude/settings.json"

  claude_settings_duplicates:
    description: "Duplicate permission entries in Claude Code settings"
    scope: project_level
    context: "The .claude/settings.json permissions.allow array should not contain duplicate entries. Duplicates are unnecessary and can cause confusion."
    requires_project_context: true
    phases:
      - name: check_duplicate_permissions
        type: claude_settings_duplicates
        failure_message: "Duplicate permission entries found in .claude/settings.json"
        expected_behavior: "All permission entries in .claude/settings.json permissions.allow should be unique"

  claude_mcp_permissions:
    description: "MCP servers missing from Claude Code settings permissions"
    scope: project_level
    context: "All MCP servers defined in .mcp.json must have corresponding MCP() permission entries in .claude/settings.json. Missing permissions prevent MCP servers from being used."
    requires_project_context: true
    phases:
      - name: check_mcp_permissions
        type: claude_mcp_permissions
        failure_message: "MCP servers missing from .claude/settings.json permissions.allow array"
        expected_behavior: "Every MCP server in .mcp.json should have a corresponding MCP(server-name) entry in .claude/settings.json"

  claude_md_quality:
    description: "CLAUDE.md file violates quality best practices"
    scope: project_level
    context: "CLAUDE.md should be concise (<1500 tokens for Anthropic), use pointers instead of large code blocks (>20 lines), avoid linting rules (use automated tools), and provide essential project context."
    requires_project_context: false
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: mixed
      file_patterns:
        - CLAUDE.md
      bundle_strategy: individual
      resource_patterns: []
    phases:
      - name: check_token_count
        type: token_count
        file_path: CLAUDE.md
        max_count: 1500
        params:
          provider: anthropic
        failure_message: "CLAUDE.md exceeds 1500 tokens (Anthropic best practice for context efficiency)"
        expected_behavior: "CLAUDE.md should be concise and under 1500 tokens"
      - name: content_quality
        type: prompt
        prompt: |
          Evaluate CLAUDE.md for content quality, code block length, and anti-patterns per Anthropic best practices.

          CRITICAL ISSUES (report these):

          **Token Efficiency**:
          1. Contains code blocks longer than 20 lines (count lines between ``` fences for each block)
          2. Large narrative paragraphs (>8 consecutive non-bullet lines) instead of bullet points

          **Completeness & Structure**:
          3. Missing ALL essential sections: tech stack, architecture, key commands/workflows, and coding standards
          4. No clear Markdown structure (no headers at all, completely unorganized)
          5. File is empty or only contains generic template boilerplate with no project-specific info

          **Anti-Patterns**:
          6. Contains detailed linting/formatting rules (e.g., "max line length 88", "import order: stdlib, third-party, local")
             → Should use automated tools (pyproject.toml, .flake8) NOT CLAUDE.md
          7. Embeds full API documentation (>30 lines of endpoint specs, schemas, or API reference)
             → Should link to API docs instead
          8. Session-specific instructions (e.g., "In this conversation..." or "For today's task...")
             → CLAUDE.md must be universal across all sessions

          ACCEPTABLE (do NOT report):
          - Code blocks under 20 lines
          - Brief narrative intros (2-3 sentences) before bullet lists
          - Variations in section naming ("Tech Stack" vs "Stack")
          - Brief sections (concise is good)
          - Missing optional sections like "Contributing"
          - Sections combined logically ("Commands & Workflows")
          - Brief style references ("We follow PEP 8, see pyproject.toml") ✓
          - Links to API docs ✓
          - General universal guidelines ✓
          - Brief code examples (2-3 lines) ✓

          EXAMPLES OF ACCEPTABLE:
          - 15-line code block ✓ (under 20)
          - "Stack: Python 3.11, FastAPI" ✓ (brief)
          - "Use black/flake8. Config in pyproject.toml" ✓ (pointer)
          - "API docs: https://example.com/api" ✓ (link)

          EXAMPLES TO FLAG:
          - 30-line code block ✗ (over 20)
          - "Linting: max-line-length=88, import order: stdlib, third-party..." ✗ (detailed rules)
          - 50-line API endpoint specification section ✗ (embedded docs)
          - "In this conversation, focus on auth module" ✗ (session-specific)
          - 12-line paragraph explaining commands ✗ (use bullets)
          - Multiple "TODO: add your..." with no actual content ✗ (template only)

          ONLY REPORT issues that significantly impact quality or violate best practices.
        available_resources: []

  agent_frontmatter:
    description: "Agent files missing or have invalid YAML frontmatter"
    scope: project_level
    context: "Agent files must have valid YAML frontmatter with required fields (name, description, model) to work properly in Claude Code."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: agent
      file_patterns:
        - .claude/agents/*.md
      bundle_strategy: individual
    phases:
      - name: check_frontmatter
        type: yaml_frontmatter
        params:
          required_fields:
            - name
            - description
            - model
          schema:
            type: object
            properties:
              name:
                type: string
                pattern: "^[a-z][a-z0-9-]*$"
                description: "Agent name must be lowercase with hyphens"
              description:
                type: string
                minLength: 10
                description: "Agent description must be at least 10 characters"
              model:
                type: string
                enum: ["sonnet", "opus", "haiku"]
                description: "Model must be one of: sonnet, opus, haiku"
              skills:
                type: array
                items:
                  type: string
                description: "Optional list of skill names"
              tools:
                type: array
                items:
                  type: string
                description: "Optional list of tool names"
            required:
              - name
              - description
              - model
        failure_message: "Agent file has invalid or missing YAML frontmatter"
        expected_behavior: "Agent files should have valid YAML frontmatter with name, description, and model fields"

  command_frontmatter:
    description: "Command files missing or have invalid YAML frontmatter"
    scope: project_level
    context: "Command files must have valid YAML frontmatter with required fields (description) to work properly in Claude Code."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: command
      file_patterns:
        - .claude/commands/*.md
      bundle_strategy: individual
    phases:
      - name: check_frontmatter
        type: yaml_frontmatter
        params:
          required_fields:
            - description
          schema:
            type: object
            properties:
              description:
                type: string
                minLength: 10
                description: "Command description must be at least 10 characters"
              skills:
                type: array
                items:
                  type: string
                description: "Optional list of skill names to activate"
            required:
              - description
        failure_message: "Command file has invalid or missing YAML frontmatter"
        expected_behavior: "Command files should have valid YAML frontmatter with a description field"

  agent_tools_format:
    description: "Agent tools must use comma-separated format, not YAML list"
    scope: project_level
    context: "Claude Code requires agent tools to be comma-separated on one line (e.g., 'tools: Read, Write, Edit') not YAML list format (tools:\\n  - Read). YAML list format causes tools to not work."
    requires_project_context: true
    supported_clients:
      - claude-code
    document_bundle:
      bundle_type: agent
      file_patterns:
        - .claude/agents/*.md
      bundle_strategy: individual
    phases:
      - name: check_tools_comma_separated
        type: regex_match
        description: "Validate tools field uses comma-separated format on single line"
        params:
          pattern: '^tools:\s+[A-Za-z][\w_]+(?:,\s*[A-Za-z][\w_]+)*\s*$'
          flags: 8
        failure_message: "Agent tools field uses YAML list format (- Read) instead of comma-separated format"
        expected_behavior: "Tools should be comma-separated on one line: 'tools: Read, Write, Edit, Grep, Glob' not YAML list with dashes"
